<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRAUMA TEAM - Advanced Medical Simulator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            user-select: none;
        }

        #gameContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
        }

        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
        }

        #uiOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }

        .debug-info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border: 1px solid #00ff00;
            font-size: 12px;
            pointer-events: none;
        }

        .medical-ui {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            border: 2px solid #ff6b6b;
            border-radius: 10px;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            backdrop-filter: blur(10px);
        }

        .tool-btn {
            width: 60px;
            height: 60px;
            background: #1a1a2e;
            border: 2px solid #4ecdc4;
            border-radius: 8px;
            color: white;
            font-size: 24px;
            cursor: pointer;
            pointer-events: all;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tool-btn:hover {
            border-color: #ff6b6b;
            transform: scale(1.1);
            background: #2a2a3e;
        }

        .tool-btn.active {
            border-color: #ffd93d;
            background: #2a2a3e;
            box-shadow: 0 0 15px #ffd93d;
        }

        .vital-signs {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.9);
            border: 2px solid #ff6b6b;
            border-radius: 10px;
            padding: 15px;
            min-width: 200px;
            backdrop-filter: blur(10px);
        }

        .vital-bar {
            height: 20px;
            background: #333;
            border-radius: 10px;
            margin: 5px 0;
            overflow: hidden;
            position: relative;
        }

        .vital-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .heart-rate { background: linear-gradient(90deg, #ff6b6b, #ff8e8e); }
        .blood-pressure { background: linear-gradient(90deg, #4ecdc4, #6bcba9); }
        .oxygen { background: linear-gradient(90deg, #ffd93d, #ff9a3d); }

        .blood-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 30% 40%, rgba(255,0,0,0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="uiOverlay">
            <div class="debug-info">
                <div>FPS: <span id="fpsCounter">0</span></div>
                <div>Triangles: <span id="triangleCount">0</span></div>
                <div>Blood Particles: <span id="particleCount">0</span></div>
            </div>

            <div class="vital-signs">
                <h3>VITAL SIGNS</h3>
                <div>Heart Rate: <span id="heartRate">80</span> BPM</div>
                <div class="vital-bar">
                    <div class="vital-fill heart-rate" style="width: 80%;"></div>
                </div>
                <div>Blood Pressure: <span id="bloodPressure">120/80</span></div>
                <div class="vital-bar">
                    <div class="vital-fill blood-pressure" style="width: 75%;"></div>
                </div>
                <div>Oxygen: <span id="oxygenLevel">98</span>%</div>
                <div class="vital-bar">
                    <div class="vital-fill oxygen" style="width: 98%;"></div>
                </div>
            </div>

            <div class="medical-ui">
                <div class="tool-btn" data-tool="tourniquet">ðŸ©¹</div>
                <div class="tool-btn" data-tool="defibrillator">âš¡</div>
                <div class="tool-btn" data-tool="oxygen">ðŸ’¨</div>
                <div class="tool-btn" data-tool="injection">ðŸ’‰</div>
                <div class="tool-btn" data-tool="bandage">ðŸ©¸</div>
                <div class="tool-btn" data-tool="surgery">ðŸ”ª</div>
            </div>

            <div class="blood-overlay" id="bloodOverlay"></div>
        </div>
    </div>

    <script>
        // ==================== ENGINE CORE ====================
        class TraumaEngine {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d', { alpha: false });
                this.glowCanvas = document.createElement('canvas');
                this.glowCtx = this.glowCanvas.getContext('2d');
                
                this.particles = [];
                this.bloodStains = [];
                this.lights = [];
                this.patientState = {
                    heartRate: 80,
                    bloodPressure: { systolic: 120, diastolic: 80 },
                    oxygen: 98,
                    bleeding: 0,
                    pain: 0
                };
                
                this.currentTool = null;
                this.mouse = { x: 0, y: 0, down: false };
                
                this.resize();
                this.initShaders();
                this.createScene();
                this.setupEventListeners();
                this.gameLoop();
            }

            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                this.glowCanvas.width = this.canvas.width;
                this.glowCanvas.height = this.canvas.height;
            }

            initShaders() {
                // Blood shader simulation
                this.bloodTexture = this.createBloodTexture();
            }

            createBloodTexture() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 256;
                canvas.height = 256;
                
                // Create organic blood pattern
                const gradient = ctx.createRadialGradient(128, 128, 0, 128, 128, 128);
                gradient.addColorStop(0, 'rgba(200, 0, 0, 0.8)');
                gradient.addColorStop(0.7, 'rgba(120, 0, 0, 0.4)');
                gradient.addColorStop(1, 'rgba(80, 0, 0, 0)');
                
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 256, 256);
                
                return canvas;
            }

            createScene() {
                // Create initial blood particles
                for (let i = 0; i < 50; i++) {
                    this.particles.push(this.createBloodParticle());
                }

                // Add dynamic lighting
                this.lights.push({
                    x: this.canvas.width / 2,
                    y: this.canvas.height / 2,
                    radius: 300,
                    intensity: 0.8,
                    color: '#4ecdc4'
                });
            }

            createBloodParticle() {
                return {
                    x: Math.random() * this.canvas.width,
                    y: Math.random() * this.canvas.height,
                    vx: (Math.random() - 0.5) * 4,
                    vy: (Math.random() - 0.5) * 4,
                    radius: Math.random() * 8 + 2,
                    life: 1,
                    decay: Math.random() * 0.02 + 0.01,
                    color: `rgba(200, ${Math.random() * 30}, ${Math.random() * 20}, 0.8)`
                };
            }

            setupEventListeners() {
                window.addEventListener('resize', () => this.resize());
                
                this.canvas.addEventListener('mousemove', (e) => {
                    this.mouse.x = e.clientX;
                    this.mouse.y = e.clientY;
                });

                this.canvas.addEventListener('mousedown', () => {
                    this.mouse.down = true;
                    this.useCurrentTool();
                });

                this.canvas.addEventListener('mouseup', () => {
                    this.mouse.down = false;
                });

                // Tool selection
                document.querySelectorAll('.tool-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.currentTool = e.target.dataset.tool;
                    });
                });
            }

            useCurrentTool() {
                if (!this.currentTool) return;

                switch(this.currentTool) {
                    case 'tourniquet':
                        this.applyTourniquet();
                        break;
                    case 'defibrillator':
                        this.defibrillate();
                        break;
                    case 'oxygen':
                        this.administerOxygen();
                        break;
                    case 'injection':
                        this.giveInjection();
                        break;
                }
            }

            applyTourniquet() {
                // Create blood spray effect
                for (let i = 0; i < 20; i++) {
                    this.particles.push({
                        x: this.mouse.x,
                        y: this.mouse.y,
                        vx: (Math.random() - 0.5) * 10,
                        vy: (Math.random() - 0.5) * 10,
                        radius: Math.random() * 6 + 2,
                        life: 1,
                        decay: Math.random() * 0.03 + 0.02,
                        color: `rgba(180, ${Math.random() * 20}, ${Math.random() * 10}, 0.9)`
                    });
                }

                // Update patient state
                this.patientState.bleeding = Math.max(0, this.patientState.bleeding - 0.3);
                this.updateVitalSigns();
            }

            defibrillate() {
                // Flash effect
                this.lights.push({
                    x: this.mouse.x,
                    y: this.mouse.y,
                    radius: 500,
                    intensity: 1,
                    color: '#ffffff',
                    decay: 0.1
                });

                // Heart rate change
                this.patientState.heartRate = Math.max(40, this.patientState.heartRate - 20 + Math.random() * 40);
                this.updateVitalSigns();
            }

            administerOxygen() {
                this.patientState.oxygen = Math.min(100, this.patientState.oxygen + 5);
                this.updateVitalSigns();
            }

            giveInjection() {
                // Create small blood spot
                this.bloodStains.push({
                    x: this.mouse.x,
                    y: this.mouse.y,
                    radius: 15,
                    opacity: 0.8
                });

                this.patientState.pain = Math.max(0, this.patientState.pain - 0.2);
                this.updateVitalSigns();
            }

            updateVitalSigns() {
                document.getElementById('heartRate').textContent = Math.round(this.patientState.heartRate);
                document.getElementById('bloodPressure').textContent = 
                    `${Math.round(this.patientState.bloodPressure.systolic)}/${Math.round(this.patientState.bloodPressure.diastolic)}`;
                document.getElementById('oxygenLevel').textContent = Math.round(this.patientState.oxygen);

                // Update UI bars
                document.querySelector('.heart-rate').style.width = `${this.patientState.heartRate}%`;
                document.querySelector('.blood-pressure').style.width = `${(this.patientState.bloodPressure.systolic / 200) * 100}%`;
                document.querySelector('.oxygen').style.width = `${this.patientState.oxygen}%`;

                // Blood overlay intensity
                const bloodIntensity = this.patientState.bleeding;
                document.getElementById('bloodOverlay').style.opacity = bloodIntensity;
            }

            updateParticles() {
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    const p = this.particles[i];
                    
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.1; // Gravity
                    p.life -= p.decay;
                    
                    if (p.life <= 0 || p.y > this.canvas.height) {
                        this.particles.splice(i, 1);
                        
                        // Leave blood stain
                        if (Math.random() < 0.3) {
                            this.bloodStains.push({
                                x: p.x,
                                y: p.y,
                                radius: p.radius * 0.5,
                                opacity: p.life * 0.8
                            });
                        }
                    }
                }

                // Add new blood particles if bleeding
                if (this.patientState.bleeding > 0 && Math.random() < this.patientState.bleeding) {
                    this.particles.push(this.createBloodParticle());
                }
            }

            updateLights() {
                for (let i = this.lights.length - 1; i >= 0; i--) {
                    const light = this.lights[i];
                    if (light.decay) {
                        light.intensity -= light.decay;
                        if (light.intensity <= 0) {
                            this.lights.splice(i, 1);
                        }
                    }
                }
            }

            render() {
                // Clear with dark medical room color
                this.ctx.fillStyle = '#0a0a1a';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                // Render blood stains first
                this.renderBloodStains();

                // Render patient body (simplified silhouette)
                this.renderPatient();

                // Render particles
                this.renderParticles();

                // Render lighting effects
                this.renderLights();

                // Render tool cursor
                this.renderCursor();
            }

            renderBloodStains() {
                this.bloodStains.forEach(stain => {
                    this.ctx.save();
                    this.ctx.globalAlpha = stain.opacity;
                    
                    const gradient = this.ctx.createRadialGradient(
                        stain.x, stain.y, 0,
                        stain.x, stain.y, stain.radius
                    );
                    gradient.addColorStop(0, 'rgba(120, 0, 0, 0.8)');
                    gradient.addColorStop(1, 'rgba(60, 0, 0, 0)');
                    
                    this.ctx.fillStyle = gradient;
                    this.ctx.fillRect(
                        stain.x - stain.radius,
                        stain.y - stain.radius,
                        stain.radius * 2,
                        stain.radius * 2
                    );
                    
                    this.ctx.restore();
                });
            }

            renderPatient() {
                const centerX = this.canvas.width / 2;
                const centerY = this.canvas.height / 2;
                
                // Body silhouette
                this.ctx.fillStyle = '#2a2a3a';
                this.ctx.beginPath();
                this.ctx.ellipse(centerX, centerY - 50, 80, 120, 0, 0, Math.PI * 2);
                this.ctx.fill();

                // Wound areas based on bleeding
                if (this.patientState.bleeding > 0) {
                    this.ctx.fillStyle = `rgba(150, 0, 0, ${this.patientState.bleeding})`;
                    this.ctx.beginPath();
                    this.ctx.arc(centerX + 40, centerY - 20, 25, 0, Math.PI * 2);
                    this.ctx.fill();
                }
            }

            renderParticles() {
                this.particles.forEach(p => {
                    this.ctx.save();
                    this.ctx.globalAlpha = p.life;
                    
                    const gradient = this.ctx.createRadialGradient(
                        p.x, p.y, 0,
                        p.x, p.y, p.radius
                    );
                    gradient.addColorStop(0, p.color);
                    gradient.addColorStop(1, 'rgba(80, 0, 0, 0)');
                    
                    this.ctx.fillStyle = gradient;
                    this.ctx.fillRect(
                        p.x - p.radius,
                        p.y - p.radius,
                        p.radius * 2,
                        p.radius * 2
                    );
                    
                    this.ctx.restore();
                });
            }

            renderLights() {
                this.lights.forEach(light => {
                    this.ctx.save();
                    
                    const gradient = this.ctx.createRadialGradient(
                        light.x, light.y, 0,
                        light.x, light.y, light.radius
                    );
                    gradient.addColorStop(0, `${light.color}${Math.floor(light.intensity * 255).toString(16).padStart(2, '0')}`);
                    gradient.addColorStop(1, '#00000000');
                    
                    this.ctx.globalCompositeOperation = 'lighter';
                    this.ctx.fillStyle = gradient;
                    this.ctx.fillRect(
                        light.x - light.radius,
                        light.y - light.radius,
                        light.radius * 2,
                        light.radius * 2
                    );
                    
                    this.ctx.restore();
                });
            }

            renderCursor() {
                if (!this.currentTool) return;

                this.ctx.save();
                this.ctx.strokeStyle = '#ffd93d';
                this.ctx.lineWidth = 2;
                this.ctx.setLineDash([5, 5]);
                this.ctx.beginPath();
                this.ctx.arc(this.mouse.x, this.mouse.y, 30, 0, Math.PI * 2);
                this.ctx.stroke();
                this.ctx.restore();
            }

            gameLoop() {
                this.updateParticles();
                this.updateLights();
                this.render();

                // Update debug info
                document.getElementById('particleCount').textContent = this.particles.length;
                document.getElementById('triangleCount').textContent = this.particles.length + this.bloodStains.length;

                requestAnimationFrame(() => this.gameLoop());
            }
        }

        // ==================== INITIALIZATION ====================
        let engine;

        function init() {
            engine = new TraumaEngine();
            
            // Start with some bleeding
            engine.patientState.bleeding = 0.7;
            engine.updateVitalSigns();
        }

        // Start when page loads
        window.addEventListener('load', init);

        // FPS counter
        let frameCount = 0;
        let lastTime = performance.now();
        function updateFPS() {
            frameCount++;
            const currentTime = performance.now();
            if (currentTime - lastTime >= 1000) {
                document.getElementById('fpsCounter').textContent = frameCount;
                frameCount = 0;
                lastTime = currentTime;
            }
            requestAnimationFrame(updateFPS);
        }
        updateFPS();
    </script>
</body>
</html>
